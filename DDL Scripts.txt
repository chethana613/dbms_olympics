DROP SCHEMA IF EXISTS tokyo_olympics CASCADE;


CREATE SCHEMA tokyo_olympics;


SET search_path TO tokyo_olympics;


CREATE TABLE Discipline (
 disc_id INT generated by default as identity primary key,
 disc_name VARCHAR(255) NOT NULL
);


CREATE TABLE Countries (
 country_id INT generated by default as identity primary key,
 country_name VARCHAR(255) NOT NULL ADD CONSTRAINT unique_country_name UNIQUE (country_name);
);


CREATE TABLE Medals (
 medal_id INT generated by default as identity primary key,
 country_id INT NOT NULL,
 rank INT,
 gold INT,
 silver INT,
 bronze INT,
 total INT,
 rank_by_total INT,
FOREIGN KEY (country_id) REFERENCES Countries(country_id)
);


CREATE TABLE Athletes (
 athlete_id INT generated by default as identity primary key,
 country_id INT NOT NULL,
 athlete_name VARCHAR(255) NOT NULL,
 disc_id INT NOT NULL,
 FOREIGN KEY (country_id) REFERENCES Countries(country_id),
 FOREIGN KEY (disc_id) REFERENCES Discipline(disc_id)
);


CREATE TABLE Events (
 event_id INT generated by default as identity primary key,
 event_name VARCHAR(255) NOT NULL,
 disc_id INT NOT NULL,
 FOREIGN KEY (disc_id) REFERENCES Discipline(disc_id)
);

CREATE TABLE Coaches (
 coach_id INT generated by default as identity primary key,
 country_id INT NOT NULL,
 coach_name VARCHAR(255) NOT NULL,
 disc_id INT NOT NULL,
 event_id INT,
 FOREIGN KEY (country_id) REFERENCES Countries(country_id),
 FOREIGN KEY (disc_id) REFERENCES Discipline(disc_id),
 FOREIGN KEY (event_id) REFERENCES Events(event_id)
);



CREATE TABLE Entries (
 entry_id INT generated by default as identity primary key,
 disc_id INT NOT NULL,
 male_count INT NOT NULL,
 female_count INT NOT NULL,
 total_count INT NOT NULL,
 FOREIGN KEY (disc_id) REFERENCES Discipline(disc_id)
);


CREATE TABLE Teams (
 team_id INT generated by default as identity primary key,
 country_id INT NOT NULL,
 disc_id INT NOT NULL,
 event_id INT NOT NULL,
 FOREIGN KEY (country_id) REFERENCES Countries(country_id),
 FOREIGN KEY (disc_id) REFERENCES Discipline(disc_id),
 FOREIGN KEY (event_id) REFERENCES Events(event_id)
);


CREATE OR REPLACE VIEW Athlete_Coaches AS
SELECT
    a.athlete_name,
    COALESCE(c.coach_name, 'No Coach Assigned')::VARCHAR(255) AS coach_name,
    d.disc_name,
    cn.country_name
FROM
    Athletes a
INNER JOIN
    Discipline d ON a.disc_id = d.disc_id
INNER JOIN
    Countries cn ON a.country_id = cn.country_id
LEFT JOIN
    Coaches c ON a.country_id = c.country_id AND a.disc_id = c.disc_id;

Select * from Athlete_Coaches LIMIT 5;

ALTER TABLE Countries
ADD CONSTRAINT unique_country_name UNIQUE (country_name);